---
title: "TIDAL CREEKS DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
     social: menu
     source_code: "https://github.com/tbep-tech/tidalcreek-dash"
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(flexdashboard)
library(tidyverse)
library(tbeptools)
# devtools::load_all('../tbeptools')
library(mapedit)
library(leaflet.extras)
library(sf)
library(reactable)
library(shinydashboard)
library(plotly)
library(shinyWidgets)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

data(tidres)
data(tidalcreeks)

# only show tb watershed
tidalcreeks <- tidalcreeks[tbshed, ]
tidres <- tidres[tidres$id %in% tidalcreeks$id, ]

source('R/funcs.R')

# iwr ref year
yr <- 2018

# join data to tidalcreeks sf
tomap <- tidalcreeks %>%
  dplyr::inner_join(tidres, by = c('id', 'wbid', 'JEI', 'class', 'name')) %>%
  dplyr::mutate(
    score = factor(score, levels = c('No Data', 'Target', 'Caution', 'Investigate', 'Act'))
  )

# context data
cntdat <- anlz_tdlcrkindic(tidalcreeks, iwrraw, yr = yr) %>% 
  select(id, wbid, JEI, class, year, CHLAC, DO, TN, chla_tn_ratio, tsi)

downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
  tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
                                      class), href = "", target = "_blank", download = NA, 
         icon("download"), label, ...)
}
```

```{r reactives}
# overview map
allmap <- reactive({
  
  out <- show_tdlcrk(tidres)
  
  return(out)
  
})

# reactive edits module for map selection
edits <- reactive({
  
  # input
  allmap <- allmap()
  
  # this modifies available options in map selection toolber
  tomap <- allmap %>% 
    addDrawToolbar(
      polylineOptions = FALSE,
      circleOptions = FALSE,
      circleMarkerOptions = FALSE,
      markerOptions = FALSE,
      editOptions = editToolbarOptions()#,
      # singleFeature = TRUE
    )
  
  out <- callModule(editMod, 'editor', tomap)
  
  return(out)
  
})

# selection from map as sf object, same crs as biodat
mapsel <- reactive({

  # input
  edits <- edits()()
  
  # requires edits to continue  
  req(!is.null(edits$finished))

  # get selection
  out <- edits$finished %>% 
    st_transform(crs = st_crs(tidalcreeks)) %>% 
    st_intersection(tidalcreeks, .) %>% 
    st_set_geometry(NULL) %>% 
    inner_join(tidres, by = c('id', 'wbid', 'JEI', 'class')) %>% 
    mutate(`Length (km)` = round(Creek_Length_m / 1000, 2)) %>% 
    select(wbid, JEI, `Length (km)`, target, caution, investigate, act, score)
  
  req(nrow(out) > 0)
  
  return(out)

})

# reactable output from map selection
maptab <- reactive({
  
  # requires edits to continue  
  validate(
    need(!is.null(edits()()$finished), 'Make selection from map')
  )
  
  # inputs
  mapsel <- mapsel()
  
  # format
  out <- reactable(mapsel, 
                   columns = list(
                         score = colDef(
                           style = function(value){
                             list(background = colfun(value))
                           }), 
                         `Length (km)` = colDef(
                            aggregate = 'sum', 
                            format = colFormat(digits = 2),
                            cell = function(value) {
                              
                              width <- paste0(value / max(mapsel$`Length (km)`) * 100, "%")
                              value <- format(value, width = 9, justify = "right")

                              bar <- div(
                                class = "bar-chart",
                                style = list(marginRight = "6px"),
                                div(class = "bar", style = list(width = width, backgroundColor = "#958984"))
                              )
                              div(class = "bar-cell", span(class = "number", value), bar)
                            }
                         ), 
                         # wbid = colDef(
                         #   aggregate = 'count'
                         # ), 
                         # JEI = colDef(
                         #   aggregate = 'count'
                         # ),
                         target = colDef(
                           aggregate = 'sum'
                         ), 
                         caution = colDef(
                           aggregate = 'sum'
                         ),  
                         investigate = colDef(
                           aggregate = 'sum'
                         ),  
                         act = colDef(
                           aggregate = 'sum'
                         )
                         
                    ), 
                   groupBy = 'score',
                   filterable = T, pageSizeOptions = c(10, 20, nrow(mapsel)), defaultPageSize = 10,
                   showPageSizeOptions = T, compact = T
  )
  
  return(out)
  
})

# no data gauge
nodtscr <- reactive({
  
  # input
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  # get gauge
  out <- sumfun(mapsel, sumsel, typsel, 'No Data')
  
  return(out)
  
})

# green gauge
grenscr <- reactive({
  
  # input
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  # get gauge
  out <- sumfun(mapsel, sumsel, typsel, 'Target')
  
  return(out)

})

# yellow gauge
yellscr <- reactive({
    
  # input
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  # get gauge
  out <- sumfun(mapsel, sumsel, typsel, 'Caution')
  
  return(out)
  
})

# orange gauge
orngscr <- reactive({
    
  # input
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  # get gauge
  out <- sumfun(mapsel, sumsel, typsel, 'Investigate')
  
  return(out)
  
})

# reds gauge
redsscr <- reactive({
  
  # input
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  # get gauge
  out <- sumfun(mapsel, sumsel, typsel, 'Act')
  
  return(out)
  
})

# summary text
sumtxt <- reactive({
  
  mapsel <- mapsel()
  sumsel <- input$sumsel
  typsel <- input$typsel
  
  req(typsel == 'sum')
  
  if(sumsel == 'by count')
    tot <- nrow(mapsel) %>% 
    paste('streams')
  
  if(sumsel == 'by creek length')
    tot <- sum(mapsel$`Length (km)`) %>% 
      round(1) %>% 
      paste('km')
    
  out <- paste('Total in selection:', tot)
  
  return(out)
  
})

# table on download tab
dwntab <- reactive({
  
  # requires edits to continue  
  validate(
    need(!is.null(edits()()$finished), 'Make selection from map')
  )
  
  # inputs
  mapsel <- mapsel()
  
  # format
  out <- reactable(mapsel, 
                   columns = list(
                         score = colDef(
                           style = function(value){
                             list(background = colfun(value))
                           })
                    ), 
                    filterable = T, pageSizeOptions = c(10, 20, nrow(mapsel)), defaultPageSize = 10,
                    showPageSizeOptions = T, compact = T
  )
  
  return(out)
  
})

# creek info from selection
seltxt <- reactive({
  
  req(selcrk)

  # data to plot
  seldat <- tidres %>% 
    filter(id %in% selcrk) %>% 
    select(name, wbid, JEI) %>% 
    mutate(
      name = case_when(
        name == '' ~ 'No name', 
        T ~ name
      )
    )
  
  out <- paste0(seldat$name, ' (WBID: ', seldat$wbid, ', JEI: ', seldat$JEI, ')')
  
  return(out)
  
})

# plot of context indicators for selected creek
cntcrkplo <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  
  req(selcrk)
  
  out <- show_tdlcrkindic(selcrk, cntdat, yr = yr, thrsel = thrsel)

  return(out)
  
})

# plot of ecdf context indicators for selected creek
cntcrkcdf <- reactive({
  
  # inputs
  thrsel <- input$thrsel
  
  req(selcrk)
  
  out <- show_tdlcrkindiccdf(selcrk, cntdat, yr = yr, thrsel = thrsel)

  return(out)
  
})

```

```{r map}
# polyline selection
output$map <- renderLeaflet({
  
  out <- show_tdlcrk(tidres)
  
  return(out)
  
})

# leaflet proxy for marker select
map <- leafletProxy('map')

# binding for marker select and year
makeReactiveBinding('selcrk')

# the selection
observeEvent(input$map_shape_click, {
  selcrk <<- input$map_shape_click$id
})

observeEvent(input$map_shape_click, {
  
  # filter spatial data by selection
  selcrkln <- tidalcreeks %>% 
    filter(id %in% selcrk)
  
  # clear markers on input select, add all points and selected point
  map <- map %>% 
    leaflet::clearMarkers() %>%
    leaflet::clearShapes() %>%
    leaflet::clearControls() %>%
    leaflet::addPolylines(data = selcrkln, opacity = 1, weight = 8, color = 'black') %>% 
    leaflet::addLegend(data = tomap, "topright", pal = pal_exp, values = ~score,
              title = "Creek scores",
              opacity = 1
    ) %>%
    leaflet::addPolylines(data = tomap, opacity = 1, weight = 1.5, color = ~pal_exp(score),
              layerId = ~id, label = ~paste0("WBID: ", wbid, ", JEI: ", JEI, ', Name: ', name, ', Creek score: ', score)
    )

})
```

```{r downloadhandlers}
# data for creek pop selection
output$cpdwntab <- downloadHandler(
  filename = function(){'tidalcreek_pop.csv'},
  content = function(file){
    todl <- mapsel() 
    write.csv(todl, file, quote = T, row.names = F)
  }
)

# data for individual creek selection
output$icdwntab <- downloadHandler(
  filename = function(){'tidalcreek_sel.csv'},
  content = function(file){
    todl <- cntdat %>% 
      filter(id %in% selcrk) %>% 
      select(-id)
    write.csv(todl, file, quote = T, row.names = F)
  }
)
```

OVERVIEW
===========================================================

Column {data-width=650}
-----------------------------------------------------------------------

### WELCOME TO THE TIDAL CREEK ASSESSMENT DASHBOARD!

#### Using the dashboard

Tidal creeks or tributaries are essential habitats in the Tampa Bay Estuary and serve as important focal points for understanding watershed inputs that affect water quality. A fundamental goal of the Tampa Bay Estuary Program is to develop effective nutrient management strategies to support the ecological function of tidal tributaries. In partnership with Sarasota Bay NEP, Coastal & Heartland NEP, and local government and agency stakeholders, preliminary methods have been developed for assessing the health of tidal tributaries for fisheries based on exceedances of nitrogen concentrations ([2016 report](https://tbeptech.org/TBEP_TECH_PUBS/2016/TBEP_02_16_SW_FL_Tidal_Creeks_Final_Draft_Report_160121.pdf), 2019 report forthcoming). These assessments can support tracking of water quality management goals and can help refine restoration and management plans in priority tributaries, including those in need of hydrologic restoration that can support critical nursery habitats for sportfishes.

This dashboard provides an interface to view and download results for all tidal creeks in the identified population of over 300 creeks in southwest Florida. The map to the left shows all locations where tidal creeks have been assessed, including those with insufficient data. Start by using the map icons on the left so draw a polygon over the map to select tidalcreeks of interest.  Once selected, the summary assessment tab will populate with data from the selection.  This tab provides an overall picture of the condition of tidal creeks.  The download tab can then be used to obtain a csv file for the selection.

#### Methods

The tidal creek dashboard uses data included in the [tbeptools](https://tbep-tech.github.io/tbeptools/) package for the population of tidal creeks in southwest Florida and includes only those creeks designated as tidal ([FDEP classes](https://floridadep.gov/dear/water-quality-standards/content/surface-water-quality-standards-classes-uses-criteria) 2 and 3M). The assessments use data from the FDEP [Impaired Waters Rule](https://www.flrules.org/gateway/ChapterHome.asp?Chapter=62-303) database, currently for run 56 available [here](http://publicfiles.dep.state.fl.us/DEAR/IWR/).  This includes data through January 10th, 2019. Raw data for both the IWR database and the tidal creek spatial date are available from the tbeptools package (see the [vignette](https://tbep-tech.github.io/tbeptools/articles/tidalcreeks.html)).  

Similar to the [water quality report card](https://shiny.tbeptech.org/wq-dash/), tidal creeks are assigned to categories within a management framework intended to serve as both a mechanism for evaluating data relative to the need for regulatory action, and to identify stewardship goals that, if properly pursued, preclude the need for any regulatory actions.  These categories were based on fish as a biological response indicator.  Additional indicators that may be more sensitive to elevated nutrient concentrations have not yet been identified and are an area of current research.  Tidal creeks are assigned to one of four categories: 

<span style="color:#33FF3B; text-shadow: 0 0 3px #333;">__Target__</span>: Creek is at or below nitrogen concentrations that protect individual creek types within the larger population of creeks.

<span style="color:#F9FF33; text-shadow: 0 0 3px #333;">__Caution__</span>: Creek nutrients showing signs of eleveted nutrient concentrations that may increase risk of eutrophic condition.

<span style="color:#FFA500; text-shadow: 0 0 3px #333;">__Investigate__</span>: Creek nutrient concentrations above margin of safety to protect creek from potnetial impairment.  

<span style="color:#FF7F50; text-shadow: 0 0 3px #333;">__Act__</span>: Creek nutrient concentrations have exceeded regulatory standard for assocaited freshwater portion of tributary indicating that actions are needed to identify remediative measures to reduce nutrients to the creek.

Conceptually, these thresholds appear in the figure below.

```{r, echo = F, out.width = '50%'}
knitr::include_graphics('www/tidalcreekreport.PNG')
```

The Act category was defined based on Florida's freshwater stream numeric nutrient criteria (NNC).Two different freshwater stream NNC are applciable to our region; the West Central NNC of 1.65 mg/l and  Peninsular region NNC of 1.54 mg/l. The histograms in the above figure represents a range of annual geometric mean (AGM) nitrogen concentrations associated with the Act and Investigate categories which are based on the NNC. In the example above, the maximum expected distribution of AGMs not to exceed of 1.65 mg/l with a 1:3 exceedence probability as defined in F.A.C. 62-303 was generated using monte carlo simulation and the highest observed standard deviation from data collected during  the first creeks study. The Investigate category was then defined as an explicit margin of safety by adjusting the distribution to find the grand geometric average that would result in a 1:20 chance of exceeding 1.65 mg/l. Assignment of a creek into the Caution category depended on a creek length adjustment as described below to protect smaller creeks from elevated nutrient concentrations.  

Note that the "Caution" category is a function of creek length. 

```{r}
totab <- tidaltargets %>% 
  rename(
    Region = region,
    Act = act,
    Investigate = investigate, 
    Caution = caution
  )
knitr::kable(totab)
```

A temporal component is also included in the assessment, whereby the overall score considers the individual categories that were observed in the previous ten years for the period of record.  For this analysis, the tidal creek assessments include data from 2008 to 2018 coinciding with the ten years prior from the most current year in the IWR period of record.  Each year of data in which nitrogen was measured at a site is given a score based on the categories defined above and an overall score is based on a frequency count for each category over the 10 year period.  The overall scores are typically assigned conservatively, such that the overall score is based on the highest category that is exceeded.  For example, a creek is assigned to the "Act" (red) category if only two of ten years exceeds the Act threshold, even if the remaining years are at target concentrations. Therefore, the framework can be considered a risk characterization representing the risk of the creek exceeding a particular threshold level.  

Finally, it is important to note that the framework outcomes do not carry any regulatory authority and are not intended to supercede any State or Federal regulatory standards currently in place, including aquatic life criteria used to evaluate waterbody impairments or pollutant load reduction goals associated with existing or forthcoming total maximum daily loads (TMDLs). The nutrient management framework was developed to serve as a screening tool to identify creeks with elevated nutrient concentrations for further evaluation to protect their in stream ecology but is not designed to explicitly identify regulatory impairments (or lack thereof) or the needs of downstream waterbodies such as larger estuarine waters that may be in need of nutrient load reductions.

All site content created by [Marcus Beck](mbeck@tbep.org), with technical support from [Mike Wessel](mwessel@janickienvironmental.com).  The page source content can be viewed on [Github](https://github.com/tbep-tech/tidalcreek-dash).

SUMMARY ASSESSMENTS
===========================================================

Column {data-width=250}
-----------------------------------------------------------------------

```{r}
# map won't render on startup unless assessment tab selected to trigger maptab
output$maptab <- renderReactable(maptab())

# this renders the map by initializing maptab on startup
outputOptions(output, "maptab", suspendWhenHidden = FALSE)

# selection editor
editModUI('editor')
```


Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### MAP SELECTION

```{r allmap}
output$nodtscr <- renderGauge(nodtscr())
output$grenscr <- renderGauge(grenscr())
output$yellscr <- renderGauge(yellscr())
output$orngscr <- renderGauge(orngscr())
output$redsscr <- renderGauge(redsscr())

fillCol(
  flex = c(1, NA, 0.25),
  reactableOutput('maptab'),
  inputPanel(
        selectInput('sumsel', 'Select summary category:', choices = c('by count', 'by creek length')), 
        selectInput('typsel', 'Select summary type:', choices = c('%', 'sum')), 
        renderText(sumtxt())
      ),
  fillRow(
    gaugeOutput('nodtscr'),
    gaugeOutput('grenscr'),
    gaugeOutput('yellscr'),
    gaugeOutput('orngscr'),
    gaugeOutput('redsscr')
  )
)
```

### DOWNLOAD

```{r}
fillCol(
  flex = c(NA, 1),
  inputPanel(
    downloadButtonRmd('cpdwntab', 'Download table')
  ),
  renderReactable(dwntab())
)
```

INDIVIDUAL CREEKS
===========================================================

Column {data-width=250}
-----------------------------------------------------------------------

```{r mapout}
leafletOutput('map')
```

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

```{r}
column(12, 
  inputPanel(
    materialSwitch(inputId = 'thrsel', label = 'Show reference lines on plots?'),
    renderText(seltxt()),
    renderUI({
      req(selcrk)
      downloadButtonRmd('icdwntab', 'Download creek data')
    })
  )
)
```

### BAR PLOTS

```{r}
renderPlotly({
  
  validate(
    need(!is.null(selcrk), 'Select creek from map')
  )
  
  validate(
    need(!is.null(cntcrkplo()), 'No data...')
  )
  
  cntcrkplo()

})
```

### RELATIVE VALUES

```{r}
renderPlotly({
  
  validate(
    need(!is.null(selcrk), 'Select creek from map')
  )
  
  validate(
    need(!is.null(cntcrkplo()), 'No data...')
  )
  
  cntcrkcdf()

})
```
