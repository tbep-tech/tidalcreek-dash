---
title: "TIDAL CREEKS DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(tbeptools)
library(mapedit)
library(leaflet.extras)
library(sf)
library(reactable)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

data(tidres)
data(tidalcreeks)

# color function for reactable cells
colfun <- function(x){
  
  out <- case_when(
    x == 'No Data' ~ 'lightblue', 
    x == 'Green' ~ 'green', 
    x == 'Yellow' ~ 'yellow', 
    x == 'Orange' ~ 'orange', 
    x == 'Red' ~ 'red'
  )
  
  return(out)
  
}
```

```{r reactives}
# overview map
allmap <- reactive({
  
  out <- show_tdlcrk(tidres)
  
  return(out)
  
})

# reactive edits module for map selection
edits <- reactive({
  
  # input
  allmap <- allmap()
  
  # this modifies available options in map selection toolber
  tomap <- allmap %>% 
    addDrawToolbar(
      polylineOptions = FALSE,
      circleOptions = FALSE,
      circleMarkerOptions = FALSE,
      markerOptions = FALSE,
      editOptions = editToolbarOptions()#,
      # singleFeature = TRUE
    )
  
  out <- callModule(editMod, 'editor', tomap)
  
  return(out)
  
})

# selection from map as sf object, same crs as biodat
mapsel <- reactive({

  # input
  edits <- edits()()
  
  # requires edits to continue  
  validate(
    need(!is.null(edits$finished), 'Make selection from map')
  )

  # get selection
  out <- edits$finished %>% 
    st_transform(crs = st_crs(tidalcreeks)) %>% 
    st_intersection(tidalcreeks, .) %>% 
    st_set_geometry(NULL) %>% 
    left_join(tidres, by = c('id', 'wbid', 'JEI', 'class')) %>% 
    mutate(`Length (km)` = round(Creek_Length_m / 1000, 2)) %>% 
    select(wbid, JEI, `Length (km)`, target, caution, action, threshold, score)
  
  # requires objects in edits to continue
  validate(
    need(nrow(out) > 0, 'No creeks in selection')
  )
  
  return(out)

})

# reactable output from map selection
maptab <- reactive({
  
  # input
  mapsel <- mapsel()

  # format
  out <- reactable(mapsel, 
                   columns = list(
                         score = colDef(
                           style = function(value){
                             list(background = colfun(value))
                           }), 
                         `Length (km)` = colDef(
                            aggregate = 'sum', 
                            format = colFormat(digits = 2),
                            cell = function(value) {
                              
                              width <- paste0(value / max(mapsel$`Length (km)`) * 100, "%")
                              value <- format(value, width = 9, justify = "right")

                              bar <- div(
                                class = "bar-chart",
                                style = list(marginRight = "6px"),
                                div(class = "bar", style = list(width = width, backgroundColor = "#3fc1c9"))
                              )
                              div(class = "bar-cell", span(class = "number", value), bar)
                            }
                         ), 
                         # wbid = colDef(
                         #   aggregate = 'count'
                         # ), 
                         # JEI = colDef(
                         #   aggregate = 'count'
                         # ),
                         target = colDef(
                           aggregate = 'sum'
                         ), 
                         caution = colDef(
                           aggregate = 'sum'
                         ),  
                         action = colDef(
                           aggregate = 'sum'
                         ),  
                         threshold = colDef(
                           aggregate = 'sum'
                         )
                         
                    ), 
                   groupBy = 'score',
                   filterable = T, pageSizeOptions = c(10, 20, nrow(mapsel)), defaultPageSize = 10,
                   showPageSizeOptions = T, compact = T
  )
  
  return(out)
  
})
```

SUMMARY ASSESSMENTS
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### MAP SELECTION

```{r allmap}
fillRow(
  flex = c(0.5, 0.02,  1),
  editModUI('editor', height = 500),
  renderText(NULL), # spacer
  renderReactable(maptab())
)
```

### FIGURE

```{r}
```
